---
title: "Issue Causal Analysis"
output: 
  html_document:
    toc: true
    number_sections: true
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Issue Causal Analysis}
  %\VignetteEncoding{UTF-8}
---

# Introduction

This notebook performs the necessary data transformations to the final table generated by `vignettes/issue_social_smell_showcase.Rmd`, in order to perform Causal Analysis using Tetrad.

```{r warning = FALSE, message = FALSE}
rm(list = ls())
seed <- 1
set.seed(seed)

require(stringi)
require(data.table)
require(knitr)
require(lubridate)
```

This file can be generated using GitHub's Sailuh/Kaiaulu [issue_social_smell_showcase.Rmd](https://github.com/sailuh/kaiaulu/blob/master/vignettes/issue_social_smell_showcase.Rmd) Notebook.

```{r}
dt <- fread("~/causal_tse/causal_modelling/1_openssl_social_smells_timeline.csv")
```


# Variable Formatting  

First, we converted from String to Integer due to Tetrad data type limitations.

Specifically, we concatenate the last two digits of the year with the last four digits of the cve_id and convert into an integer. (E.g. 2006 and CVE ID XXX4339 becomes 06339).

```{r}
last_two_digits_year <- stringi::stri_sub(dt$cve_id,from=7,to = 8)
last_four_digits_cve <- stringi::stri_sub(dt$cve_id,from=10,to = 14)
dt$cve_id <- as.integer(stringi::stri_c(last_two_digits_year,last_four_digits_cve))
```

Second, commit interval is transformed into `activity_0` and `activity_2` if the commit hash is missing or available respectively:

```{r}
dt$activity_0 <- ifelse(dt$commit_interval == "",1,0)
dt$activity_2 <- ifelse(dt$commit_interval != "",1,0)
```

A number of variable name are also shortened, so their visual representation do not take too much screen space:

```{r}
setnames(x=dt,
         old = c("start_day",
                 "missing_links",
                 "radio_silence",
                 "st_congruence",
                 "communicability",
                 "code_only_devs",
                 "code_files",
                 "ml_only_devs",
                 "ml_threads",
                 "n_commits",
                 "sum_churn"),
         new = c("start",
                 "mis_link",
                 "silence",
                 "congruence",
                 "communicate",
                 "code_dev",
                 "file",
                 "mail_dev",
                 "thread",
                 "commit",
                 "churn"))

dt <- dt[,.(cve_id,
            activity_0,
            activity_2,
            start,
            org_silo,
            mis_link,
            silence,
            congruence,
            communicate,
            code_dev,
            file,
            mail_dev,
            thread,
            commit,
            churn
            )]

#openssl_social_smells_timeline..renameVariables.csv
```

# Missing Data Transformations

We decided to remove rows from the dataset for which the mailing list data source is missing (i.e. 2000-2001).

```{r}
dt$start <- lubridate::ymd_hms(dt$start)
dt <- dt[(year(start) < 2000) | (year(start) > 2001)]
```

With respect to data missing due to inactivity durin given time period, any measures of features (counts) related to commits should all be 0.

```{r}
setnafill(dt, cols = colnames(dt), fill = 0)

# openssl_social_smells_timeline..renameVariables..resolveMD.csv
```

# Appending Variables Representing the Next Time Period 

```{r}

add_time_lag <- function(cve_table){
  table <- cve_table
  
  if(nrow(table) < 2){
       lag_table <- cbind(table,
                          table[,.(org_silo2 = NA,
                                   mis_link2 = NA,
                                   silence2 = NA,
                                   congruence2 = NA,
                                   communicate2 = NA,
                                   code_dev2 = NA,
                                   file2 = NA,
                                   mail_dev2 = NA,
                                   thread2 = NA,
                                   commit2 = NA,
                                   churn2 = NA)])
  }else{
     lag_table <- cbind(table[1:(nrow(table)-1)],
                     table[2:nrow(table),
                           .(org_silo2 = org_silo,
                             mis_link2 = mis_link,
                             silence2 = silence,
                             congruence2 = congruence,
                             communicate2 = communicate,
                             code_dev2 = code_dev,
                             file2 = file,
                             mail_dev2 = mail_dev,
                             thread2 = thread,
                             commit2 = commit,
                             churn2 = churn)])
  }
  return(lag_table)
}
```

```{r}
lag_dt <- dt[order(cve_id,start)][, add_time_lag(.SD),
             by = c("cve_id")]

# openssl_social_smells_timeline..renameVariables..resolveMD..deleteLastRecordEachCVE.csv
```

# Remove CVEs Whose Timeline is Too Short

We deleted the 7 CVEs (their associated rows) with 7 or fewer time periods. Their deletion leaves us with a total of 35 fewer rows.

```{r}
short_cves <- lag_dt[,.(n_rows=.N),by="cve_id"][order(n_rows)][n_rows <= 7]
short_cves
```
```{r}
short_cve_ids <- short_cves$cve_id
lag_dt <- lag_dt[!(cve_id %in% short_cve_ids)]
# openssl_social_smells_timeline..renameVariables..resolveMD..deleteLastRecordEachCVE..deleteShortCVEs.csv
```

# Addressing Determinism and High Intercorrelation Among Features
```{r}
cor_table <- lag_dt[,.(org_silo,
                       mis_link,
                       silence,
                       congruence,
                       communicate, 
                       code_dev,
                       file,
                       mail_dev,
                       thread,
                       commit,
                       churn,
                       org_silo2,
                       mis_link2,
                       silence2,
                       congruence2,
                       communicate2,
                       code_dev2,
                       file2,
                       mail_dev2,
                       thread2,
                       commit2,
                       churn2)]
cor(cor_table)
```

Due to high correlation, we perform 6 feature deletions (activity_0, activity_2, org_silo, org_silo2, communicate, communicate2):

```{r}
lag_dt <- lag_dt[,.(cve_id,
                    start,
                    mis_link,
                    silence,
                    congruence,
                    code_dev,
                    file,
                    mail_dev,
                    thread,
                    commit,
                    churn,
                    mis_link2,
                    silence2,
                    congruence2,
                    code_dev2,
                    file2,
                    mail_dev2,
                    thread2,
                    commit2,
                    churn2)]
# + [openssl_social_smells_timeline..renameVariables..resolveMD..deleteLastRecordEachCVE..deleteShortCVEs..delDmsmHighCorr.csv
```

# Binarize CVE ID

```{r}
# Extract only the cve_id column, assign that they should have 1 value 
# when dcasted, and an id column for the formula for dcast. 

binarize_cve_id <- lag_dt[,.(id = c(1:nrow(lag_dt)),
                             cve_id= stringi::stri_c("b_",cve_id),
                             binary_value = 1)]
binarize_cve_id <- dcast(binarize_cve_id,id ~ cve_id,
                         value.var = "binary_value",
                         fill=0)
head(cbind(cve_id=lag_dt$cve_id,binarize_cve_id))
```

We can then remove the `cve_id` column, and add the remaining columns to the analysis table:

```{r}
# Remove cve_id
lag_dt <- lag_dt[,.(start,
                    mis_link,
                    silence,
                    congruence,
                    code_dev,
                    file,
                    mail_dev,
                    thread,
                    commit,
                    churn,
                    mis_link2,
                    silence2,
                    congruence2,
                    code_dev2,
                    file2,
                    mail_dev2,
                    thread2,
                    commit2,
                    churn2)]

# Add all binary columns except cve_id from the new table

lag_dt <- cbind(lag_dt,binarize_cve_id[,(2:ncol(binarize_cve_id)),with=FALSE])
# bin-openssl_social_smells_timeline..renameVariables..resolveMD..deleteLastRecordEachCVE..deleteShortCVEs..delDmsmHighCorr.csv
```

# Add Null Features

Having performed our initial screening that indicates which of the “b_*” variables it’s perhaps more worthwhile to create a null variable for, we move on to prepare for the main search of our entire analysis.

An example of the randomization only showing the silence and nv-silence is shown below. In practice, for every column in `lag_dt` up to this point, we generated a replica column prefixed by `nv-`, including the binary features (which are then prefixed as `nv-b_`), but the replica columns have their values shufled across the rows, hence the null (random) naming to them.

```{r}
nv_lag_dt <- lag_dt
colnames(nv_lag_dt) <- stringi::stri_c("nv-",colnames(lag_dt))
nv_lag_dt <- apply(nv_lag_dt,2,sample)
nv_lag_dt <- cbind(lag_dt,nv_lag_dt)
head(nv_lag_dt[,.(silence,`nv-silence`)])
```

